//PRIMERO SE HACEN LOS DROPS

DROP TABLE detalle_servicio     CASCADE CONSTRAINTS;
DROP TABLE mantencion           CASCADE CONSTRAINTS;
DROP TABLE servicio             CASCADE CONSTRAINTS;
DROP TABLE automovil            CASCADE CONSTRAINTS;
DROP TABLE mecanico             CASCADE CONSTRAINTS;
DROP TABLE cliente              CASCADE CONSTRAINTS;
DROP TABLE sucursal             CASCADE CONSTRAINTS;
DROP TABLE ciudad               CASCADE CONSTRAINTS;
DROP TABLE pais                 CASCADE CONSTRAINTS;

DROP SEQUENCE seq_servicio;
DROP SEQUENCE seq_ciudad;


//Parte 1: CREACION DE TABLAS

CREATE TABLE pais (
    id_pais     NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 9 INCREMENT BY 3),
    nombre      VARCHAR2(50) NOT NULL,
    
    CONSTRAINT pais_pk 
    PRIMARY KEY (id_pais)
);

CREATE TABLE ciudad (
    id_ciudad       NUMBER NOT NULL,
    nombre          VARCHAR2(60) NOT NULL,
    id_pais         NUMBER NOT NULL,
    
    CONSTRAINT ciudad_pk 
    PRIMARY KEY (id_ciudad),
    
    CONSTRAINT ciudad_pais_fk 
        FOREIGN KEY (id_pais) 
        REFERENCES pais(id_pais)
);

CREATE TABLE sucursal (
    id_sucursal     VARCHAR2(3) NOT NULL,
    nombre          VARCHAR2(80) NOT NULL,
    direccion       VARCHAR2(120) NOT NULL,
    id_ciudad       NUMBER NOT NULL,
    
    CONSTRAINT sucursal_pk 
    PRIMARY KEY (id_sucursal),
    
    CONSTRAINT sucursal_ciudad_fk 
        FOREIGN KEY (id_ciudad) 
        REFERENCES ciudad(id_ciudad)
);

CREATE TABLE cliente (
    rut                     NUMBER(8) NOT NULL,
    dv                      CHAR(1) NOT NULL,
    primer_nombre           VARCHAR2(40) NOT NULL,
    segundo_nombre          VARCHAR2(40),
    apellido_paterno        VARCHAR2(40) NOT NULL,
    apellido_materno        VARCHAR2(40),
    tipo_cliente            VARCHAR2(10) NOT NULL,
    email                   VARCHAR2(100),
    telefono                VARCHAR2(15),
    
    CONSTRAINT cliente_pk 
    PRIMARY KEY (rut)
);

CREATE TABLE mecanico (
    id_mecanico             NUMBER(5) NOT NULL,
    primer_nombre           VARCHAR2(40) NOT NULL,
    segundo_nombre          VARCHAR2(40),
    apellido_paterno        VARCHAR2(40) NOT NULL,
    apellido_materno        VARCHAR2(40),
    bono_jefatura           NUMBER(10),
    sueldo                  NUMBER(10) NOT NULL,
    impuesto                NUMBER(10) NOT NULL,
    id_supervisor           NUMBER,
    id_sucursal             VARCHAR2(3) NOT NULL,
    
    CONSTRAINT mecanico_pk 
    PRIMARY KEY (id_mecanico),
    
    CONSTRAINT mecanico_supervisor_fk 
        FOREIGN KEY (id_supervisor) REFERENCES mecanico(id_mecanico),
    
    CONSTRAINT mecanico_sucursal_fk 
        FOREIGN KEY (id_sucursal) REFERENCES sucursal(id_sucursal)
);

CREATE TABLE automovil (
    patente         VARCHAR2(10) NOT NULL,
    marca           VARCHAR2(40),
    modelo          VARCHAR2(40),
    anio            NUMBER(4),
    rut_cliente     NUMBER,
    
    CONSTRAINT automovil_pk 
    PRIMARY KEY (patente)
);

CREATE TABLE servicio (
    id_servicio     NUMBER NOT NULL,
    descripcion     VARCHAR2(100) NOT NULL,
    costo           NUMBER(10) NOT NULL,
    
    CONSTRAINT servicio_pk 
    PRIMARY KEY (id_servicio)
);

CREATE TABLE mantencion (
    id_mantencion       NUMBER NOT NULL,
    id_sucursal         VARCHAR2(3) NOT NULL,
    fecha_llegada       DATE NOT NULL,
    fecha_salida        DATE,
    patente             VARCHAR2(10),
    id_mecanico         NUMBER NOT NULL,
    estado              VARCHAR2(15) NOT NULL,
    
    CONSTRAINT mantencion_pk 
    PRIMARY KEY (id_mantencion, id_sucursal),
    
    CONSTRAINT mantencion_mecanico_fk 
        FOREIGN KEY (id_mecanico) 
        REFERENCES mecanico(id_mecanico),
    
    CONSTRAINT mantencion_sucursal_fk 
        FOREIGN KEY (id_sucursal) 
        REFERENCES sucursal(id_sucursal)
);

CREATE TABLE detalle_servicio (
    id_mantencion           NUMBER NOT NULL,
    id_sucursal             VARCHAR2(3) NOT NULL,
    id_servicio             NUMBER NOT NULL,
    cantidad                NUMBER(3),
    
    CONSTRAINT detalle_servicio_pk 
        PRIMARY KEY (id_mantencion, id_sucursal, id_servicio),
    
    CONSTRAINT detalle_mant_fk 
        FOREIGN KEY (id_mantencion, id_sucursal) 
        REFERENCES mantencion(id_mantencion, id_sucursal),
    
    CONSTRAINT detalle_serv_fk 
        FOREIGN KEY (id_servicio) 
        REFERENCES servicio(id_servicio)
);


//Caso 3: POBLAMIENTO

CREATE SEQUENCE seq_servicio START WITH 400 INCREMENT BY 2;
CREATE SEQUENCE seq_ciudad START WITH 165 INCREMENT BY 5;


// PAIS
INSERT INTO pais (nombre) VALUES ('Chile');
INSERT INTO pais (nombre) VALUES ('Peru');
INSERT INTO pais (nombre) VALUES ('Colombia');

// CIUDAD
INSERT INTO ciudad VALUES (seq_ciudad.NEXTVAL,'Santiago',9);
INSERT INTO ciudad VALUES (seq_ciudad.NEXTVAL,'Lima',12);
INSERT INTO ciudad VALUES (seq_ciudad.NEXTVAL,'Bogota',15);

// SUCURSAL
INSERT INTO sucursal VALUES ('S01','Providencia','Av. A. Varas 234',165);
INSERT INTO sucursal VALUES ('S02','Las 4 esquinas','Av. Latina 669',170);
INSERT INTO sucursal VALUES ('S03','El Cafetero','Av. El Faro 900',175);

// SERVICIO
INSERT INTO servicio VALUES (seq_servicio.NEXTVAL,'Cambio Luces',45000);
INSERT INTO servicio VALUES (seq_servicio.NEXTVAL,'Desabolladura',67000);
INSERT INTO servicio VALUES (seq_servicio.NEXTVAL,'Revision Frenos',30000);
INSERT INTO servicio VALUES (seq_servicio.NEXTVAL,'Cambio Puerta Trasera',50000);

INSERT INTO mecanico 
(id_mecanico, primer_nombre, segundo_nombre, apellido_paterno, apellido_materno,
 bono_jefatura, sueldo, impuesto, id_supervisor, id_sucursal)
VALUES 
(460,'Jorge','Pablo','Soto','Sierra',NULL,540000,75000,NULL,'S01');

INSERT INTO mecanico 
(id_mecanico, primer_nombre, segundo_nombre, apellido_paterno, apellido_materno,
 bono_jefatura, sueldo, impuesto, id_supervisor, id_sucursal)
VALUES 
(467,'Pedro','Jose','Manrique','Corral',NULL,750000,23980,NULL,'S01');

INSERT INTO mecanico 
(id_mecanico, primer_nombre, segundo_nombre, apellido_paterno, apellido_materno,
 bono_jefatura, sueldo, impuesto, id_supervisor, id_sucursal)
VALUES 
(474,'Sandra','Josefa','Letelier','S.',NULL,659000,22358,460,'S02');

INSERT INTO mecanico 
(id_mecanico, primer_nombre, segundo_nombre, apellido_paterno, apellido_materno,
 bono_jefatura, sueldo, impuesto, id_supervisor, id_sucursal)
VALUES 
(481,'Felipe',NULL,'Vidal','A.',NULL,750000,23580,460,'S02');

INSERT INTO mecanico 
(id_mecanico, primer_nombre, segundo_nombre, apellido_paterno, apellido_materno,
 bono_jefatura, sueldo, impuesto, id_supervisor, id_sucursal)
VALUES 
(502,'Carlos','Felipe','Soto','J.',NULL,597000,23580,474,'S02');

INSERT INTO mecanico 
(id_mecanico, primer_nombre, segundo_nombre, apellido_paterno, apellido_materno,
 bono_jefatura, sueldo, impuesto, id_supervisor, id_sucursal)
VALUES 
(509,'Alberto','Cerdan','Ramirez',NULL,NULL,559000,22380,460,'S03');

// MANTENCION
INSERT INTO mantencion VALUES (101,'S01',DATE '2023-04-12',NULL,NULL,481,'Reserva');
INSERT INTO mantencion VALUES (102,'S02',DATE '2023-02-21',DATE '2023-02-21',NULL,502,'Entregado');
INSERT INTO mantencion VALUES (103,'S02',DATE '2023-10-09',NULL,NULL,502,'Anulado');
INSERT INTO mantencion VALUES (104,'S03',DATE '2023-08-11',DATE '2023-08-18',NULL,509,'Entregado');
INSERT INTO mantencion VALUES (105,'S03',DATE '2023-12-03',NULL,NULL,509,'Ingresado');




//caso 4: informes

SELECT id_mecanico AS "ID MECANICO",
       primer_nombre || ' ' || apellido_paterno AS "NOMBRE MECANICO",
       sueldo AS "SALARIO",
       impuesto AS "IMPUESTO ACTUAL",
       impuesto*0.8 AS "IMPUESTO REBAJADO",
       sueldo - (impuesto*0.8) AS "SUELDO CON REBAJA IMPUESTOS"
FROM mecanico
WHERE bono_jefatura IS NULL
AND impuesto < 40000
ORDER BY impuesto DESC, apellido_paterno ASC;

SELECT id_mecanico AS "IDENTIFICADOR",
       primer_nombre || ' ' || NVL(segundo_nombre,'') || ' ' || apellido_paterno AS "MECANICO",
       sueldo AS "SALARIO ACTUAL",
       sueldo*0.05 AS "AJUSTE",
       sueldo*1.05 AS "SUELDO_REAJUSTADO"
FROM mecanico
WHERE sueldo BETWEEN 600000 AND 900000
   OR id_supervisor IS NULL
ORDER BY sueldo ASC, primer_nombre DESC;